{% extends "base.html" %}
{% block content %}

<div class="topbar" style="margin:.5rem 0 1rem;">
  <a href="{{ url_for('day_view', datestr=prev_day.strftime('%Y-%m-%d')) }}">â† {{ prev_day.strftime('%m/%d') }}</a>
  <h3 style="margin:0;">{{ d.strftime('%Y-%m-%d') }}ï¼ˆ{{ ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'][d.weekday()] }}ï¼‰</h3>
  <a href="{{ url_for('day_view', datestr=next_day.strftime('%Y-%m-%d')) }}">{{ next_day.strftime('%m/%d') }} â†’</a>
</div>

<section>
  <h4>ç•¶æ—¥é£²é£Ÿç´€éŒ„</h4>
  <details open>
    <summary>æ–°å¢é¤é»</summary>
    <form method="post" action="{{ url_for('diet_add') }}">
      <input type="hidden" name="date" value="{{ d.strftime('%Y-%m-%d') }}">
      <div style="display:grid; grid-template-columns: 1fr 2fr 1fr 1fr 1fr 1fr; gap:.5rem; align-items:flex-start;">
        <label>é¤åˆ¥
          <select name="meal_type" required>
            {% for val, label in MEAL_TYPES %}
              <option value="{{ val }}">{{ label }}</option>
            {% endfor %}
          </select>
        </label>
        
        <label style="position: relative;">é£Ÿå“åç¨±
          <input name="food_name" 
                 id="food_name_input" 
                 placeholder="ä¾‹å¦‚ï¼šé›èƒ¸ä¾¿ç•¶" 
                 autocomplete="off"
                 required>
          <div id="suggestions_box"></div>
        </label>
        <label>ç†±é‡(kcal)
          <input type="number" step="0.01" name="kcal" value="0" id="kcal_input">
        </label>
        <label>è›‹ç™½è³ª(g)
          <input type="number" step="0.01" name="protein_g" value="0" id="protein_input">
        </label>
        <label>è„‚è‚ª(g)
          <input type="number" step="0.01" name="fat_g" value="0" id="fat_input">
        </label>
        <label>ç¢³æ°´(g)
          <input type="number" step="0.01" name="carb_g" value="0" id="carb_input">
        </label>
      </div>
      <div style="margin-top:.5rem;"><button type="submit">æ–°å¢é¤é»</button></div>
    </form>
  </details>

  <article style="margin-top:1rem;">
    <header><strong>ä»Šæ—¥é£²é£Ÿç¸½è¨ˆ</strong></header>
    <div>ç†±é‡ï¼š{{ '%.2f'|format(totals_diet.kcal) }} kcal</div>
    <div>è›‹ç™½è³ªï¼š{{ '%.2f'|format(totals_diet.protein_g) }} g</div>
    <div>è„‚è‚ªï¼š{{ '%.2f'|format(totals_diet.fat_g) }} g</div>
    <div>ç¢³æ°´ï¼š{{ '%.2f'|format(totals_diet.carb_g) }} g</div>
  </article>

  <section style="margin-top:1rem;">
    <h5>å…¨åŸŸæ¯æ—¥ç‡Ÿé¤Šç›®æ¨™ï¼ˆå¾é¦–é è¨­å®šï¼‰</h5>

    {% if nutrition_goal %}
      <style>
        .nutri-row { margin-top:.4rem; }
        .nutri-label { display:flex; justify-content:space-between; font-size:.85rem; margin-bottom:.1rem; }
        .nutri-bar { position:relative; height:0.6rem; border-radius:999px; background:#e5e7eb; overflow:hidden; }
        .nutri-fill { position:absolute; inset:0; border-radius:999px; background:#22c55e; }
        .nutri-diff { font-size:.8rem; color:#4b5563; }
      </style>

      <div class="nutri-row">
        <div class="nutri-label">
          <span>ç†±é‡</span>
          <span>{{ '%.0f'|format(totals_diet.kcal) }} / {{ '%.0f'|format(nutrition_goal.kcal_target or 0) }} kcal</span>
        </div>
        <div class="nutri-bar">
          {% if nutrition_percent and nutrition_percent['kcal'] is not none %}
            <div class="nutri-fill" style="width: {{ '%.0f'|format(nutrition_percent['kcal']) }}%;"></div>
          {% endif %}
        </div>
        {% if nutrition_diff %}
          <div class="nutri-diff">å·®å€¼ï¼š{{ '%+.0f'|format(nutrition_diff['kcal']) }} kcal</div>
        {% endif %}
      </div>

      <div class="nutri-row">
        <div class="nutri-label">
          <span>ç¢³æ°´</span>
          <span>{{ '%.1f'|format(totals_diet.carb_g) }} / {{ '%.1f'|format(nutrition_goal.carb_target or 0) }} g</span>
        </div>
        <div class="nutri-bar">
          {% if nutrition_percent and nutrition_percent['carb'] is not none %}
            <div class="nutri-fill" style="width: {{ '%.0f'|format(nutrition_percent['carb']) }}%;"></div>
          {% endif %}
        </div>
        {% if nutrition_diff %}
          <div class="nutri-diff">å·®å€¼ï¼š{{ '%+.1f'|format(nutrition_diff['carb']) }} g</div>
        {% endif %}
      </div>

      <div class="nutri-row">
        <div class="nutri-label">
          <span>è›‹ç™½è³ª</span>
          <span>{{ '%.1f'|format(totals_diet.protein_g) }} / {{ '%.1f'|format(nutrition_goal.protein_target or 0) }} g</span>
        </div>
        <div class="nutri-bar">
          {% if nutrition_percent and nutrition_percent['protein'] is not none %}
            <div class="nutri-fill" style="width: {{ '%.0f'|format(nutrition_percent['protein']) }}%;"></div>
          {% endif %}
        </div>
        {% if nutrition_diff %}
          <div class="nutri-diff">å·®å€¼ï¼š{{ '%+.1f'|format(nutrition_diff['protein']) }} g</div>
        {% endif %}
      </div>

      <div class="nutri-row">
        <div class="nutri-label">
          <span>è„‚è‚ª</span>
          <span>{{ '%.1f'|format(totals_diet.fat_g) }} / {{ '%.1f'|format(nutrition_goal.fat_target or 0) }} g</span>
        </div>
        <div class="nutri-bar">
          {% if nutrition_percent and nutrition_percent['fat'] is not none %}
            <div class="nutri-fill" style="width: {{ '%.0f'|format(nutrition_percent['fat']) }}%;"></div>
          {% endif %}
        </div>
        {% if nutrition_diff %}
          <div class="nutri-diff">å·®å€¼ï¼š{{ '%+.1f'|format(nutrition_diff['fat']) }} g</div>
        {% endif %}
      </div>
    {% else %}
      <p class="muted" style="margin-top:.5rem;">å°šæœªè¨­å®šå…¨åŸŸç‡Ÿé¤Šç›®æ¨™ï¼Œè«‹å›é¦–é è¨­å®šã€‚</p>
    {% endif %}
  </section>

  <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:1rem; margin-top:1rem;">
    {% for meal in ['æ—©é¤','åˆé¤','æ™šé¤','é»å¿ƒ'] %}
      <div>
        <h5>{{ meal }}</h5>
        {% set arr = diets_by_meal.get(meal, []) %}
        {% if arr|length == 0 %}
          <small class="muted">å°šç„¡ç´€éŒ„</small>
        {% else %}
          <table>
            <thead><tr><th>é£Ÿå“</th><th>kcal</th><th>è›‹ç™½</th><th>è„‚è‚ª</th><th>ç¢³æ°´</th><th></th></tr></thead>
            <tbody>
              {% for de in arr %}
                <tr>
                  <td>{{ de.food_name }}</td>
                  <td>{{ '%.2f'|format(de.kcal or 0) }}</td>
                  <td>{{ '%.2f'|format(de.protein_g or 0) }}</td>
                  <td>{{ '%.2f'|format(de.fat_g or 0) }}</td>
                  <td>{{ '%.2f'|format(de.carb_g or 0) }}</td>
                  <td>
                    <form method="post" action="{{ url_for('diet_delete', diet_id=de.id) }}">
                      <button class="secondary outline" onclick="return confirm('åˆªé™¤æ­¤é¤é»ï¼Ÿ')">åˆªé™¤</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endif %}
      </div>
    {% endfor %}
  </div>
</section>

<hr>

<section>
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h4>ç•¶æ—¥é‡è¨“ç´€éŒ„</h4>
    <a href="{{ url_for('rest_timer') }}" class="secondary outline" style="margin-bottom:1rem;">ä¼‘æ¯è¨ˆæ™‚å™¨</a>
  </div>

  <details open>
    <summary>æ–°å¢ä¸€çµ„</summary>
    <form method="post" action="{{ url_for('strength_add') }}">
      <input type="hidden" name="date" value="{{ d.strftime('%Y-%m-%d') }}">
      <div style="display:grid; grid-template-columns: 1fr 1.5fr 1fr 1fr; gap:.5rem; align-items:end;">
        <label>éƒ¨ä½
          <select name="body_part" id="body_part_select" required>
            {% for part, exs in STRENGTH_CATEGORIES.items() %}
              <option value="{{ part }}">{{ part }}</option>
            {% endfor %}
          </select>
        </label>
        <label>å‹•ä½œ
          <select name="exercise_name" id="exercise_select" required></select>
        </label>
        <label>é‡é‡(kg)
          <input type="number" step="0.5" name="weight_kg" value="0">
        </label>
        <label>æ¬¡æ•¸
          <input type="number" step="1" min="0" name="reps" value="0">
        </label>
      </div>
      <div style="margin-top:.25rem;">
        <small id="last_max_text" class="muted">ä¸Šæ¬¡æœ€å¤§é‡é‡ï¼šâ€” kg</small>
      </div>
      <div style="margin-top:.5rem;"><button type="submit">æ–°å¢ä¸€çµ„</button></div>
    </form>

    <script type="application/json" id="cats-json">{{ STRENGTH_CATEGORIES | tojson }}</script>
    <script type="application/json" id="lastmax-json">{{ last_max_weight | tojson }}</script>

    <script>
      const CATS = JSON.parse(document.getElementById('cats-json').textContent);
      const LAST_MAX = JSON.parse(document.getElementById('lastmax-json').textContent || '{}');

      const partSel = document.getElementById('body_part_select');
      const exSel = document.getElementById('exercise_select');
      const lastMaxEl = document.getElementById('last_max_text');

      function refillExercises() {
        const part = partSel.value;
        const list = CATS[part] || [];
        exSel.innerHTML = '';
        list.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          exSel.appendChild(opt);
        });
        updateLastMax();
      }

      function updateLastMax() {
        const ex = exSel.value;
        const w = LAST_MAX[ex];
        if (w === undefined || w === null) {
          lastMaxEl.textContent = 'ä¸Šæ¬¡æœ€å¤§é‡é‡ï¼šâ€” kg';
        } else {
          lastMaxEl.textContent = 'ä¸Šæ¬¡æœ€å¤§é‡é‡ï¼š' + Number(w).toFixed(1) + ' kg';
        }
      }

      partSel.addEventListener('change', refillExercises);
      exSel.addEventListener('change', updateLastMax);
      refillExercises();
    </script>
  </details>

  <article style="margin-top:1rem;">
    <header><strong>ä»Šæ—¥ç¸½é‡é‡</strong></header>
    <div>ç¸½é‡é‡ï¼š{{ '%.2f'|format(total_weight) }} kg</div>
    {% if prev_total_weight is not none %}
      <div>
        èˆ‡ä¸Šæ¬¡è¨“ç·´æ—¥å·®å€¼ï¼š{{ '%+.2f'|format(total_diff_vs_prev) }} kg
        ï¼ˆä¸Šæ¬¡ {{ prev_total_date.strftime('%Y-%m-%d') }}ï¼š{{ '%.2f'|format(prev_total_weight) }} kgï¼‰
      </div>
    {% else %}
      <div class="muted">å°šç„¡ä¸Šæ¬¡è¨“ç·´æ—¥ç´€éŒ„</div>
    {% endif %}
    <small class="muted">ç¸½é‡é‡ = æ‰€æœ‰çµ„åˆ¥ Î£(é‡é‡ Ã— æ¬¡æ•¸)ã€‚</small>
  </article>

  {% if strength_by_part|length == 0 %}
    <p class="muted" style="margin-top:.5rem;">å°šç„¡é‡è¨“ç´€éŒ„</p>
  {% else %}
    {% for part, ex_map in strength_by_part.items() %}
      <h5 style="margin-top:1rem;">{{ part }}</h5>
      {% for ex_name, sets in ex_map.items() %}
        <details open style="margin:.25rem 0;">
          <summary>
            <strong>{{ ex_name }}</strong>
            <a href="{{ url_for('progress', exercise_name=ex_name) }}" 
               class="secondary" 
               style="margin-left:.5rem; font-size: 0.8rem;">
               ğŸ“Š é€²æ­¥æ›²ç·š
            </a>
          </summary>
          <table>
            <thead><tr><th>é‡é‡(kg)</th><th>æ¬¡æ•¸</th><th>å°è¨ˆ(kg)</th><th></th></tr></thead>
            <tbody>
              {% for s in sets %}
                {% set subtotal = (s.weight_kg or 0) * (s.reps or 0) %}
                <tr>
                  <td>{{ '%.2f'|format(s.weight_kg or 0) }}</td>
                  <td>{{ s.reps or 0 }}</td>
                  <td>
                    {{ '%.2f'|format(subtotal) }}
                    {% if s.id == exercise_best_set_id.get(ex_name) %}
                      <strong style="color:#ef4444; margin-left:.25rem;">PR</strong>
                    {% endif %}
                  </td>
                  <td>
                    <form method="post" action="{{ url_for('strength_delete', set_id=s.id) }}">
                      <button class="secondary outline" onclick="return confirm('åˆªé™¤æ­¤çµ„ï¼Ÿ')">åˆªé™¤</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </details>
      {% endfor %}
    {% endfor %}
  {% endif %}
</section>

<hr>

<section>
  <h4>ç•¶æ—¥è¡Œäº‹é …</h4>
  <a href="{{ url_for('add', date=d.strftime('%Y-%m-%d')) }}" class="secondary">ï¼‹ æ–°å¢è¡Œäº‹é …</a>
  {% if items|length == 0 %}
    <p class="muted">å°šç„¡è¡Œäº‹é …</p>
  {% else %}
    <ul>
      {% for it in items %}
        <li style="margin-bottom:.5rem;">
          <span class="badge">{{ it.item_type }}</span>
          <strong>{{ it.title }}</strong>
          <small>ï¼ˆ{{ it.time_range_str() }}ï¼‰</small>
          {% if it.content %}<div style="color:#4b5563;">{{ it.content }}</div>{% endif %}
          <div class="actions" style="margin-top:.2rem;">
            <a href="{{ url_for('edit', item_id=it.id) }}" class="secondary">ç·¨è¼¯</a>
            <form action="{{ url_for('delete', item_id=it.id) }}" method="post" style="display:inline;">
              <button class="outline" onclick="return confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')">åˆªé™¤</button>
            </form>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% endif %}
</section>

<script src="{{ url_for('static', filename='js/diet_suggest.js') }}"></script>

<hr>

<section>
  <h4>ç•¶æ—¥æ—¥è¨˜</h4>

  {% if diary_entries|length == 0 %}
    <p class="muted">ä»Šå¤©å°šç„¡æ—¥è¨˜ã€‚</p>
  {% else %}
    {% for entry in diary_entries %}
      <article style="border:1px solid #ddd; padding:1rem; border-radius:8px; margin-bottom:1rem;">
        <header>
          <strong>{{ entry.title if entry.title else '(ç„¡æ¨™é¡Œ)' }}</strong>
          <small class="muted" style="margin-left:0.5rem;">( {{ entry.created_at.strftime('%H:%M:%S') }} )</small>
        </header>
        
        <div class="trix-content">
          {{ entry.content | safe }}
        </div>
        
        <footer style="margin-top:0.5rem; display:flex; gap:0.5rem;">
          <a href="{{ url_for('diary_edit', entry_id=entry.id) }}" 
             role="button" 
             class="secondary outline">ç·¨è¼¯</a>
          
          <form action="{{ url_for('diary_delete', entry_id=entry.id) }}" method="POST" style="margin:0;">
            <button type="submit" 
                    class="secondary outline" 
                    onclick="return confirm('ç¢ºå®šè¦åˆªé™¤é€™ç¯‡æ—¥è¨˜å—ï¼Ÿ')">åˆªé™¤</button>
          </form>
        </footer>
      </article>
    {% endfor %}
  {% endif %}

  <hr>

  <details>
    <summary>ï¼‹ æ–°å¢ä¸€ç¯‡æ—¥è¨˜</summary>
    <form action="{{ url_for('diary_add', datestr=d.strftime('%Y-%m-%d')) }}" method="POST" style="margin-top:1rem;">
      
      <label for="diary_title_new">æ¨™é¡Œ</label>
      <input type="text" id="diary_title_new" name="title" placeholder="ï¼ˆå¯é¸ï¼‰æ–°æ—¥è¨˜æ¨™é¡Œ">

      <input id="diary_content_new" type="hidden" name="content">
      <trix-editor input="diary_content_new"></trix-editor>

      <button type="submit" style="margin-top:1rem;">æ–°å¢æ—¥è¨˜</button>
    </form>
  </details>
</section>

{% endblock %}