{% extends "base.html" %}
{% block content %}

<div class="topbar" style="margin:.5rem 0 1rem;">
  <a href="{{ url_for('day_view', datestr=prev_day.strftime('%Y-%m-%d')) }}">← {{ prev_day.strftime('%m/%d') }}</a>
  <h3 style="margin:0;">{{ d.strftime('%Y-%m-%d') }}（{{ ['一','二','三','四','五','六','日'][d.weekday()] }}）</h3>
  <a href="{{ url_for('day_view', datestr=next_day.strftime('%Y-%m-%d')) }}">{{ next_day.strftime('%m/%d') }} →</a>
</div>

<!-- 當日飲食紀錄（在日期詳情頁顯示） -->
<section>
  <h4>當日飲食紀錄</h4>
  <details open>
    <summary>新增餐點</summary>
    <form method="post" action="{{ url_for('diet_add') }}">
      <input type="hidden" name="date" value="{{ d.strftime('%Y-%m-%d') }}">
      <div style="display:grid; grid-template-columns: 1fr 2fr 1fr 1fr 1fr 1fr; gap:.5rem;">
        <label>
          餐別
          <select name="meal_type" required>
            {% for val, label in MEAL_TYPES %}
              <option value="{{ val }}">{{ label }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          食品名稱
          <input name="food_name" placeholder="例如：雞胸便當" required>
        </label>
        <label>熱量(kcal)<input type="number" step="0.01" name="kcal" value="0"></label>
        <label>蛋白質(g)<input type="number" step="0.01" name="protein_g" value="0"></label>
        <label>脂肪(g)<input type="number" step="0.01" name="fat_g" value="0"></label>
        <label>碳水(g)<input type="number" step="0.01" name="carb_g" value="0"></label>
      </div>
      <div style="margin-top:.5rem;"><button type="submit">新增餐點</button></div>
    </form>
  </details>

  <article style="margin-top:1rem;">
    <header><strong>今日飲食總計</strong></header>
    <div>熱量：{{ '%.2f'|format(totals_diet.kcal) }} kcal</div>
    <div>蛋白質：{{ '%.2f'|format(totals_diet.protein_g) }} g</div>
    <div>脂肪：{{ '%.2f'|format(totals_diet.fat_g) }} g</div>
    <div>碳水：{{ '%.2f'|format(totals_diet.carb_g) }} g</div>
  </article>

  <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:1rem; margin-top:1rem;">
    {% for meal in ['早餐','午餐','晚餐','點心'] %}
      <div>
        <h5>{{ meal }}</h5>
        {% set arr = diets_by_meal.get(meal, []) %}
        {% if arr|length == 0 %}
          <small class="muted">尚無紀錄</small>
        {% else %}
          <table>
            <thead><tr><th>食品</th><th>kcal</th><th>蛋白</th><th>脂肪</th><th>碳水</th><th></th></tr></thead>
            <tbody>
              {% for de in arr %}
                <tr>
                  <td>{{ de.food_name }}</td>
                  <td>{{ '%.2f'|format(de.kcal or 0) }}</td>
                  <td>{{ '%.2f'|format(de.protein_g or 0) }}</td>
                  <td>{{ '%.2f'|format(de.fat_g or 0) }}</td>
                  <td>{{ '%.2f'|format(de.carb_g or 0) }}</td>
                  <td>
                    <form method="post" action="{{ url_for('diet_delete', diet_id=de.id) }}">
                      <button class="secondary outline" onclick="return confirm('刪除此餐點？')">刪除</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endif %}
      </div>
    {% endfor %}
  </div>
</section>

<hr>

<!-- 當日重訓紀錄（在日期詳情頁顯示） -->
<section>
  <h4>當日重訓紀錄</h4>

  <details open>
    <summary>新增一組</summary>
    <form method="post" action="{{ url_for('strength_add') }}">
      <input type="hidden" name="date" value="{{ d.strftime('%Y-%m-%d') }}">

      <div style="display:grid; grid-template-columns: 1fr 1.5fr 1fr 1fr; gap:.5rem; align-items:end;">
        <label>
          部位
          <select name="body_part" id="body_part_select" required>
            {% for part, exs in STRENGTH_CATEGORIES.items() %}
              <option value="{{ part }}">{{ part }}</option>
            {% endfor %}
          </select>
        </label>

        <label>
          動作
          <select name="exercise_name" id="exercise_select" required>
            <!-- 由 JS 依部位填入；同一動作可能屬於多個部位 -->
          </select>
        </label>

        <label>
          重量(kg)
          <input type="number" step="0.5" name="weight_kg" value="0">
        </label>

        <label>
          次數
          <input type="number" step="1" min="0" name="reps" value="0">
        </label>
      </div>

      <div style="margin-top:.5rem;"><button type="submit">新增一組</button></div>
    </form>

    <script>
      // 將 Python 字典轉為 JS 物件
      const CATS = {{ STRENGTH_CATEGORIES | tojson }};
      const partSel = document.getElementById('body_part_select');
      const exSel = document.getElementById('exercise_select');

      function refillExercises() {
        const part = partSel.value;
        const list = CATS[part] || [];
        exSel.innerHTML = '';
        list.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name; opt.textContent = name;
          exSel.appendChild(opt);
        });
      }
      partSel.addEventListener('change', refillExercises);
      // 初次載入
      refillExercises();
    </script>
  </details>

  <article style="margin-top:1rem;">
    <header><strong>今日總重量</strong></header>
    <div>總重量：{{ '%.2f'|format(total_weight) }} kg</div>
    <small class="muted">總重量 = 所有組別 Σ (重量 × 次數)。體重訓練請依需要填入估算重量，或輸入 0（不計入總重量）。</small>
  </article>

  {% if strength_by_part|length == 0 %}
    <p class="muted" style="margin-top:.5rem;">尚無重訓紀錄</p>
  {% else %}
    {% for part, ex_map in strength_by_part.items() %}
      <h5 style="margin-top:1rem;">{{ part }}</h5>
      {% for ex_name, sets in ex_map.items() %}
        <details open style="margin:.25rem 0;">
          <summary><strong>{{ ex_name }}</strong></summary>
          <table>
            <thead><tr><th>重量(kg)</th><th>次數</th><th>小計(kg)</th><th></th></tr></thead>
            <tbody>
              {% set subtotal = 0 %}
              {% for s in sets %}
                {% set subtotal = subtotal + ((s.weight_kg or 0) * (s.reps or 0)) %}
                <tr>
                  <td>{{ '%.2f'|format(s.weight_kg or 0) }}</td>
                  <td>{{ s.reps or 0 }}</td>
                  <td>{{ '%.2f'|format((s.weight_kg or 0) * (s.reps or 0)) }}</td>
                  <td>
                    <form method="post" action="{{ url_for('strength_delete', set_id=s.id) }}">
                      <button class="secondary outline" onclick="return confirm('刪除此組？')">刪除</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr>
                <th colspan="2" style="text-align:right;">此動作小計：</th>
                <th>{{ '%.2f'|format(subtotal) }} kg</th>
                <th></th>
              </tr>
            </tfoot>
          </table>
        </details>
      {% endfor %}
    {% endfor %}
  {% endif %}
</section>

<hr>

<!-- 當日行事項 -->
<section>
  <h4>當日行事項</h4>
  <a href="{{ url_for('add', date=d.strftime('%Y-%m-%d')) }}" class="secondary">＋ 新增行事項</a>
  {% if items|length == 0 %}
    <p class="muted">尚無行事項</p>
  {% else %}
    <ul>
      {% for it in items %}
        <li style="margin-bottom:.5rem;">
          <span class="badge">{{ it.item_type }}</span>
          <strong>{{ it.title }}</strong>
          <small>（{{ it.time_range_str() }}）</small>
          {% if it.content %}<div style="color:#4b5563;">{{ it.content }}</div>{% endif %}
          <div class="actions" style="margin-top:.2rem;">
            <a href="{{ url_for('edit', item_id=it.id) }}" class="secondary">編輯</a>
            <form action="{{ url_for('delete', item_id=it.id) }}" method="post" style="display:inline;">
              <button class="outline" onclick="return confirm('確定刪除？')">刪除</button>
            </form>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% endif %}
</section>

{% endblock %}
