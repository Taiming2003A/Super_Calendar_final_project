{% extends "base.html" %}
{% block content %}

<div class="topbar" style="margin:.5rem 0 1rem;">
  <a href="{{ url_for('day_view', datestr=prev_day.strftime('%Y-%m-%d')) }}">← {{ prev_day.strftime('%m/%d') }}</a>
  <h3 style="margin:0;">{{ d.strftime('%Y-%m-%d') }}（{{ ['一','二','三','四','五','六','日'][d.weekday()] }}）</h3>
  <a href="{{ url_for('day_view', datestr=next_day.strftime('%Y-%m-%d')) }}">{{ next_day.strftime('%m/%d') }} →</a>
</div>

<!-- 當日飲食紀錄 -->
<section>
  <h4>當日飲食紀錄</h4>
  <details open>
    <summary>新增餐點</summary>
    <form method="post" action="{{ url_for('diet_add') }}">
      <input type="hidden" name="date" value="{{ d.strftime('%Y-%m-%d') }}">
      <div style="display:grid; grid-template-columns: 1fr 2fr 1fr 1fr 1fr 1fr; gap:.5rem;">
        <label>餐別
          <select name="meal_type" required>
            {% for val, label in MEAL_TYPES %}
              <option value="{{ val }}">{{ label }}</option>
            {% endfor %}
          </select>
        </label>
        <label>食品名稱
          <input name="food_name" placeholder="例如：雞胸便當" required>
        </label>
        <label>熱量(kcal)
          <input type="number" step="0.01" name="kcal" value="0">
        </label>
        <label>蛋白質(g)
          <input type="number" step="0.01" name="protein_g" value="0">
        </label>
        <label>脂肪(g)
          <input type="number" step="0.01" name="fat_g" value="0">
        </label>
        <label>碳水(g)
          <input type="number" step="0.01" name="carb_g" value="0">
        </label>
      </div>
      <div style="margin-top:.5rem;"><button type="submit">新增餐點</button></div>
    </form>
  </details>

  <article style="margin-top:1rem;">
    <header><strong>今日飲食總計</strong></header>
    <div>熱量：{{ '%.2f'|format(totals_diet.kcal) }} kcal</div>
    <div>蛋白質：{{ '%.2f'|format(totals_diet.protein_g) }} g</div>
    <div>脂肪：{{ '%.2f'|format(totals_diet.fat_g) }} g</div>
    <div>碳水：{{ '%.2f'|format(totals_diet.carb_g) }} g</div>
  </article>

  <!-- 只顯示「全域營養目標」的視覺化 -->
  <section style="margin-top:1rem;">
    <h5>全域每日營養目標（從首頁設定）</h5>

    {% if nutrition_goal %}
      <style>
        .nutri-row { margin-top:.4rem; }
        .nutri-label { display:flex; justify-content:space-between; font-size:.85rem; margin-bottom:.1rem; }
        .nutri-bar { position:relative; height:0.6rem; border-radius:999px; background:#e5e7eb; overflow:hidden; }
        .nutri-fill { position:absolute; inset:0; border-radius:999px; background:#22c55e; }
        .nutri-diff { font-size:.8rem; color:#4b5563; }
      </style>

      <!-- 熱量 -->
      <div class="nutri-row">
        <div class="nutri-label">
          <span>熱量</span>
          <span>{{ '%.0f'|format(totals_diet.kcal) }} / {{ '%.0f'|format(nutrition_goal.kcal_target or 0) }} kcal</span>
        </div>
        <div class="nutri-bar">
          {% if nutrition_percent and nutrition_percent['kcal'] is not none %}
            <div class="nutri-fill" style="width: {{ '%.0f'|format(nutrition_percent['kcal']) }}%;"></div>
          {% endif %}
        </div>
        {% if nutrition_diff %}
          <div class="nutri-diff">差值：{{ '%+.0f'|format(nutrition_diff['kcal']) }} kcal</div>
        {% endif %}
      </div>

      <!-- 碳水 -->
      <div class="nutri-row">
        <div class="nutri-label">
          <span>碳水</span>
          <span>{{ '%.1f'|format(totals_diet.carb_g) }} / {{ '%.1f'|format(nutrition_goal.carb_target or 0) }} g</span>
        </div>
        <div class="nutri-bar">
          {% if nutrition_percent and nutrition_percent['carb'] is not none %}
            <div class="nutri-fill" style="width: {{ '%.0f'|format(nutrition_percent['carb']) }}%;"></div>
          {% endif %}
        </div>
        {% if nutrition_diff %}
          <div class="nutri-diff">差值：{{ '%+.1f'|format(nutrition_diff['carb']) }} g</div>
        {% endif %}
      </div>

      <!-- 蛋白質 -->
      <div class="nutri-row">
        <div class="nutri-label">
          <span>蛋白質</span>
          <span>{{ '%.1f'|format(totals_diet.protein_g) }} / {{ '%.1f'|format(nutrition_goal.protein_target or 0) }} g</span>
        </div>
        <div class="nutri-bar">
          {% if nutrition_percent and nutrition_percent['protein'] is not none %}
            <div class="nutri-fill" style="width: {{ '%.0f'|format(nutrition_percent['protein']) }}%;"></div>
          {% endif %}
        </div>
        {% if nutrition_diff %}
          <div class="nutri-diff">差值：{{ '%+.1f'|format(nutrition_diff['protein']) }} g</div>
        {% endif %}
      </div>

      <!-- 脂肪 -->
      <div class="nutri-row">
        <div class="nutri-label">
          <span>脂肪</span>
          <span>{{ '%.1f'|format(totals_diet.fat_g) }} / {{ '%.1f'|format(nutrition_goal.fat_target or 0) }} g</span>
        </div>
        <div class="nutri-bar">
          {% if nutrition_percent and nutrition_percent['fat'] is not none %}
            <div class="nutri-fill" style="width: {{ '%.0f'|format(nutrition_percent['fat']) }}%;"></div>
          {% endif %}
        </div>
        {% if nutrition_diff %}
          <div class="nutri-diff">差值：{{ '%+.1f'|format(nutrition_diff['fat']) }} g</div>
        {% endif %}
      </div>
    {% else %}
      <p class="muted" style="margin-top:.5rem;">尚未設定全域營養目標，請回首頁設定。</p>
    {% endif %}
  </section>

  <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:1rem; margin-top:1rem;">
    {% for meal in ['早餐','午餐','晚餐','點心'] %}
      <div>
        <h5>{{ meal }}</h5>
        {% set arr = diets_by_meal.get(meal, []) %}
        {% if arr|length == 0 %}
          <small class="muted">尚無紀錄</small>
        {% else %}
          <table>
            <thead><tr><th>食品</th><th>kcal</th><th>蛋白</th><th>脂肪</th><th>碳水</th><th></th></tr></thead>
            <tbody>
              {% for de in arr %}
                <tr>
                  <td>{{ de.food_name }}</td>
                  <td>{{ '%.2f'|format(de.kcal or 0) }}</td>
                  <td>{{ '%.2f'|format(de.protein_g or 0) }}</td>
                  <td>{{ '%.2f'|format(de.fat_g or 0) }}</td>
                  <td>{{ '%.2f'|format(de.carb_g or 0) }}</td>
                  <td>
                    <form method="post" action="{{ url_for('diet_delete', diet_id=de.id) }}">
                      <button class="secondary outline" onclick="return confirm('刪除此餐點？')">刪除</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endif %}
      </div>
    {% endfor %}
  </div>
</section>

<hr>

<!-- 當日重訓紀錄（跟之前一樣：PR、上次最大重量、總重量差值） -->
<section>
  <h4>當日重訓紀錄</h4>
  <a href="{{ url_for('rest_timer') }}" class="secondary" style="margin-bottom:1rem;">休息計時器</a>

  <details open>
    <summary>新增一組</summary>
    <form method="post" action="{{ url_for('strength_add') }}">
      <input type="hidden" name="date" value="{{ d.strftime('%Y-%m-%d') }}">
      <div style="display:grid; grid-template-columns: 1fr 1.5fr 1fr 1fr; gap:.5rem; align-items:end;">
        <label>部位
          <select name="body_part" id="body_part_select" required>
            {% for part, exs in STRENGTH_CATEGORIES.items() %}
              <option value="{{ part }}">{{ part }}</option>
            {% endfor %}
          </select>
        </label>
        <label>動作
          <select name="exercise_name" id="exercise_select" required></select>
        </label>
        <label>重量(kg)
          <input type="number" step="0.5" name="weight_kg" value="0">
        </label>
        <label>次數
          <input type="number" step="1" min="0" name="reps" value="0">
        </label>
      </div>
      <div style="margin-top:.25rem;">
        <small id="last_max_text" class="muted">上次最大重量：— kg</small>
      </div>
      <div style="margin-top:.5rem;"><button type="submit">新增一組</button></div>
    </form>

    <script type="application/json" id="cats-json">{{ STRENGTH_CATEGORIES | tojson }}</script>
    <script type="application/json" id="lastmax-json">{{ last_max_weight | tojson }}</script>

    <script>
      const CATS = JSON.parse(document.getElementById('cats-json').textContent);
      const LAST_MAX = JSON.parse(document.getElementById('lastmax-json').textContent || '{}');

      const partSel = document.getElementById('body_part_select');
      const exSel = document.getElementById('exercise_select');
      const lastMaxEl = document.getElementById('last_max_text');

      function refillExercises() {
        const part = partSel.value;
        const list = CATS[part] || [];
        exSel.innerHTML = '';
        list.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          exSel.appendChild(opt);
        });
        updateLastMax();
      }

      function updateLastMax() {
        const ex = exSel.value;
        const w = LAST_MAX[ex];
        if (w === undefined || w === null) {
          lastMaxEl.textContent = '上次最大重量：— kg';
        } else {
          lastMaxEl.textContent = '上次最大重量：' + Number(w).toFixed(1) + ' kg';
        }
      }

      partSel.addEventListener('change', refillExercises);
      exSel.addEventListener('change', updateLastMax);
      refillExercises();
    </script>
  </details>

  <article style="margin-top:1rem;">
    <header><strong>今日總重量</strong></header>
    <div>總重量：{{ '%.2f'|format(total_weight) }} kg</div>
    {% if prev_total_weight is not none %}
      <div>
        與上次訓練日差值：{{ '%+.2f'|format(total_diff_vs_prev) }} kg
        （上次 {{ prev_total_date.strftime('%Y-%m-%d') }}：{{ '%.2f'|format(prev_total_weight) }} kg）
      </div>
    {% else %}
      <div class="muted">尚無上次訓練日紀錄</div>
    {% endif %}
    <small class="muted">總重量 = 所有組別 Σ(重量 × 次數)。</small>
  </article>

  {% if strength_by_part|length == 0 %}
    <p class="muted" style="margin-top:.5rem;">尚無重訓紀錄</p>
  {% else %}
    {% for part, ex_map in strength_by_part.items() %}
      <h5 style="margin-top:1rem;">{{ part }}</h5>
      {% for ex_name, sets in ex_map.items() %}
        <details open style="margin:.25rem 0;">
          <summary>
            <strong>{{ exercise_name }}</strong>
            <a href="{{ url_for('progress', exercise_name=exercise_name) }}"
           class="secondary" style="margin-left:.5rem;">
             進步曲線
           </a>
          </summary>

           
          <table>
            <thead><tr><th>重量(kg)</th><th>次數</th><th>小計(kg)</th><th></th></tr></thead>
            <tbody>
              {% for s in sets %}
                {% set subtotal = (s.weight_kg or 0) * (s.reps or 0) %}
                <tr>
                  <td>{{ '%.2f'|format(s.weight_kg or 0) }}</td>
                  <td>{{ s.reps or 0 }}</td>
                  <td>
                    {{ '%.2f'|format(subtotal) }}
                    {% if s.id == exercise_best_set_id.get(ex_name) %}
                      <strong style="color:#ef4444; margin-left:.25rem;">PR</strong>
                    {% endif %}
                  </td>
                  <td>
                    <form method="post" action="{{ url_for('strength_delete', set_id=s.id) }}">
                      <button class="secondary outline" onclick="return confirm('刪除此組？')">刪除</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </details>
      {% endfor %}
    {% endfor %}
  {% endif %}
</section>

<hr>

<!-- 當日行事項 -->
<section>
  <h4>當日行事項</h4>
  <a href="{{ url_for('add', date=d.strftime('%Y-%m-%d')) }}" class="secondary">＋ 新增行事項</a>
  {% if items|length == 0 %}
    <p class="muted">尚無行事項</p>
  {% else %}
    <ul>
      {% for it in items %}
        <li style="margin-bottom:.5rem;">
          <span class="badge">{{ it.item_type }}</span>
          <strong>{{ it.title }}</strong>
          <small>（{{ it.time_range_str() }}）</small>
          {% if it.content %}<div style="color:#4b5563;">{{ it.content }}</div>{% endif %}
          <div class="actions" style="margin-top:.2rem;">
            <a href="{{ url_for('edit', item_id=it.id) }}" class="secondary">編輯</a>
            <form action="{{ url_for('delete', item_id=it.id) }}" method="post" style="display:inline;">
              <button class="outline" onclick="return confirm('確定刪除？')">刪除</button>
            </form>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% endif %}
</section>

{% endblock %}
